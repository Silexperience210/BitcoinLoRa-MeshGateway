name: Build APK

on:
  push:
    branches: [ main ]
  workflow_dispatch:

jobs:
  build:
    runs-on: ubuntu-latest

    steps:
    - uses: actions/checkout@v4

    - name: Set up JDK
      uses: actions/setup-java@v4
      with:
        java-version: '17'
        distribution: 'temurin'

    - name: Setup Gradle 8.4
      uses: gradle/actions/setup-gradle@v3
      with:
        gradle-version: '8.4'
        cache-disabled: true

    - name: Build Debug APK (signed)
      working-directory: ./android
      run: gradle assembleDebug --no-daemon

    - name: Upload APK Artifact
      uses: actions/upload-artifact@v4
      with:
        name: BitcoinMesh-APK
        path: android/app/build/outputs/apk/debug/app-debug.apk

  release:
    needs: build
    runs-on: ubuntu-latest
    permissions:
      contents: write

    steps:
    - name: Download APK
      uses: actions/download-artifact@v4
      with:
        name: BitcoinMesh-APK

    - name: Rename APK
      run: mv app-debug.apk BitcoinMesh-v2.0-NEON.apk

    - name: Delete old release
      run: |
        gh release delete v2.0.0 --yes || true
        git push origin :refs/tags/v2.0.0 || true
      env:
        GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
      continue-on-error: true

    - name: Create Release
      uses: softprops/action-gh-release@v1
      with:
        tag_name: v2.0.0
        name: "âš¡ BitcoinMesh v2.0 NEON"
        body: |
          ## âš¡ BitcoinMesh v2.0 NEON

          **ðŸ”¥ Direct BLE Connection to Meshtastic!**

          ### ðŸ†• Features
          - ðŸ“¡ **Direct BLE** - Connects directly to T-Beam
          - ðŸŽ¨ **Cyberpunk UI** - Dark theme with neon effects
          - âš¡ **Pulse animations** - Animated glow effects
          - ðŸ“¦ **Auto-chunking** - Splits TX into 190-byte packets
          - ðŸ”„ **Real-time progress** - See each packet transmit

          ### ðŸ“¥ Installation
          1. Download **BitcoinMesh-v2.0-NEON.apk**
          2. Enable "Unknown Sources" on Android
          3. Install & grant Bluetooth permissions
          4. Open app and tap SCAN
          5. Connect to your T-Beam
          6. Paste TX hex and BROADCAST!

          ### ðŸ“‹ Requirements
          - Android 8.0+ (API 26)
          - T-Beam with Meshtastic firmware
          - Bluetooth enabled

          ---
          **âš¡ By [Silexperience210](https://github.com/Silexperience210) & [@ProfEduStream](https://github.com/ProfEduStream)** ðŸŽ“
        files: BitcoinMesh-v2.0-NEON.apk
        make_latest: true
      env:
        GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
