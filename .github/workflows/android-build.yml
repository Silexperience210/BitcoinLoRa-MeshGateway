name: Android Build & Release

on:
  push:
    branches: [ main ]
  workflow_dispatch:

jobs:
  build:
    runs-on: ubuntu-latest

    steps:
    - uses: actions/checkout@v4

    - name: Set up JDK
      uses: actions/setup-java@v4
      with:
        java-version: '17'
        distribution: 'temurin'

    - name: Setup Gradle 8.4
      uses: gradle/actions/setup-gradle@v3
      with:
        gradle-version: '8.4'
        cache-disabled: true

    - name: Build APK
      working-directory: ./android
      run: gradle assembleRelease --no-daemon

    - name: Upload APK Artifact
      uses: actions/upload-artifact@v4
      with:
        name: BitcoinMesh-APK
        path: android/app/build/outputs/apk/release/app-release-unsigned.apk

  release:
    needs: build
    runs-on: ubuntu-latest
    permissions:
      contents: write

    steps:
    - name: Download APK
      uses: actions/download-artifact@v4
      with:
        name: BitcoinMesh-APK

    - name: Rename APK
      run: mv app-release-unsigned.apk BitcoinMesh-v2.0-NEON.apk

    - name: Delete old release
      run: |
        gh release delete v2.0.0 --yes || true
        git push origin :refs/tags/v2.0.0 || true
      env:
        GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
      continue-on-error: true

    - name: Create Release
      uses: softprops/action-gh-release@v1
      with:
        tag_name: v2.0.0
        name: "âš¡ BitcoinMesh v2.0 NEON"
        body: |
          ## âš¡ BitcoinMesh v2.0 NEON
          
          **ðŸ”¥ COMPLETE REWRITE - Direct BLE Connection!**
          
          ### ðŸ†• What's New
          - ðŸ“¡ **Direct BLE** - No more Bluetooth SPP issues!
          - ðŸŽ¨ **Futuristic UI** - Cyberpunk dark theme
          - âš¡ **Pulse animations** - Neon glow effects
          - ðŸ“¦ **Protobuf encoding** - Native Meshtastic protocol
          - ðŸ”„ **Real-time progress** - See each packet transmit
          
          ### âœ¨ UI Features
          - ðŸŒ‘ Deep black background with orange neon accents
          - ðŸ’« Animated pulse rings around logo
          - ðŸ”® Glass panels with holographic borders
          - ðŸ’» Terminal-style log output
          - ðŸ”¥ Intense glow on broadcast button
          - ðŸ“Š Neon progress bar
          
          ### ðŸ“¥ Installation
          1. Download BitcoinMesh-v2.0-NEON.apk
          2. Enable "Unknown Sources" on Android
          3. Install & grant Bluetooth permissions
          4. Scan for your T-Beam
          5. Connect & broadcast!
          
          ### ðŸ“‹ Requirements
          - Android 8.0+ (API 26)
          - T-Beam with Meshtastic firmware
          - Gateway running on PC
          
          ---
          **âš¡ By [Silexperience](https://github.com/Silexperience210) & [@ProfEduStream](https://github.com/ProfEduStream)** ðŸŽ“
        files: BitcoinMesh-v2.0-NEON.apk
        make_latest: true
      env:
        GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
